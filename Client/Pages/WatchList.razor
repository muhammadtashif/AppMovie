@page "/watchlist"
@using MovieRental.Shared
@using MovieRental.Client.Services
@inject IndexedDbService IndexedDbService
@inject NavigationManager Navigation
@implements IDisposable

<div class="page-header">
    <h1 class="page-title">My Watch List</h1>
    <p class="page-subtitle">Your rented movies available for 24 hours</p>
</div>

<div class="container">
    @if (isLoading)
    {
        <div class="empty-state">
            <div class="empty-state-icon">‚è≥</div>
            <h2 class="empty-state-title">Loading Your Watch List...</h2>
        </div>
    }
    else if (rentals == null || !rentals.Any())
    {
        <div class="empty-state">
            <div class="empty-state-icon">üì∫</div>
            <h2 class="empty-state-title">Your Watch List is Empty</h2>
            <p class="empty-state-text">Browse movies and click "Watch Now" to add them here!</p>
            <button class="btn btn-primary" @onclick="GoToHome" style="margin-top: 1rem;">
                Browse Movies
            </button>
        </div>
    }
    else
    {
        <div class="movie-grid fade-in">
            @foreach (var rental in rentals)
            {
                <div class="card">
                    <img src="@rental.ImageUrl" alt="@rental.MovieTitle" class="card-img" />
                    <div class="card-body">
                        <h3 class="card-title">@rental.MovieTitle</h3>
                        
                        @if (rental.IsExpired)
                        {
                            <div class="badge badge-warning" style="margin-bottom: 1rem;">
                                ‚è∞ Expired
                            </div>
                        }
                        else
                        {
                            <div class="badge badge-success" style="margin-bottom: 1rem;">
                                ‚úì Active
                            </div>
                        }
                        
                        <div class="rental-info">
                            <div class="rental-info-item">
                                <span class="rental-info-label">Rented:</span>
                                <span class="rental-info-value">@rental.RentedAt.ToLocalTime().ToString("MMM dd, HH:mm")</span>
                            </div>
                            <div class="rental-info-item">
                                <span class="rental-info-label">Expires:</span>
                                <span class="rental-info-value">@rental.ExpiresAt.ToLocalTime().ToString("MMM dd, HH:mm")</span>
                            </div>
                            @if (!rental.IsExpired)
                            {
                                <div class="rental-info-item">
                                    <span class="rental-info-label">Time Remaining:</span>
                                    <span class="rental-info-value">@GetTimeRemaining(rental)</span>
                                </div>
                            }
                            <div class="rental-info-item">
                                <span class="rental-info-label">Price Paid:</span>
                                <span class="rental-info-value">$@rental.Price.ToString("F2")</span>
                            </div>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            @if (rental.IsExpired)
                            {
                                <button class="btn btn-secondary" @onclick="() => RemoveRental(rental.MovieId)">
                                    üóëÔ∏è Remove
                                </button>
                            }
                            else
                            {
                                <button class="btn btn-primary" style="width: 100%;">
                                    ‚ñ∂ Watch Now
                                </button>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Rental> rentals = new();
    private bool isLoading = true;
    private System.Threading.Timer? timer;

    protected override async Task OnInitializedAsync()
    {
        await LoadRentals();
        
        // Set up timer to refresh every minute
        timer = new System.Threading.Timer(async _ =>
        {
            await InvokeAsync(async () =>
            {
                await LoadRentals();
                StateHasChanged();
            });
        }, null, TimeSpan.FromMinutes(1), TimeSpan.FromMinutes(1));
    }

    private async Task LoadRentals()
    {
        isLoading = true;
        await IndexedDbService.RemoveExpiredRentalsAsync();
        rentals = await IndexedDbService.GetAllRentalsAsync();
        rentals = rentals.OrderByDescending(r => r.RentedAt).ToList();
        isLoading = false;
    }

    private async Task RemoveRental(string movieId)
    {
        await IndexedDbService.RemoveRentalAsync(movieId);
        await LoadRentals();
    }

    private void GoToHome()
    {
        Navigation.NavigateTo("/");
    }

    private string GetTimeRemaining(Rental rental)
    {
        if (rental.IsExpired)
            return "Expired";

        var remaining = rental.TimeRemaining;
        
        if (remaining.TotalHours >= 1)
            return $"{(int)remaining.TotalHours}h {remaining.Minutes}m";
        else if (remaining.TotalMinutes >= 1)
            return $"{(int)remaining.TotalMinutes}m";
        else
            return "Less than 1 minute";
    }

    public void Dispose()
    {
        timer?.Dispose();
    }
}
